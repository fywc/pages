# TMAå¼‚æ­¥å•å…ƒåˆ†æ

# TMAäº§ç”ŸèƒŒæ™¯

GPUä¸­ï¼Œæ•°æ®å‚¨å­˜åœ¨Global Memoryï¼ˆä¸€èˆ¬ä¸ºHBMï¼Œä¸‹ç§°GMEMï¼‰ï¼Œè®¡ç®—å•å…ƒï¼ˆCUDA core/ Tensor coreï¼‰ä½äºSMä¸­ï¼Œæ•°æ®éœ€è¦æ¬è¿åˆ°SMå†…çš„Shared Memoryï¼ˆä¸‹ç§°SMEMï¼‰ä¸­ç”¨äºè®¡ç®—ï¼Œè®¡ç®—åå†æ¬å›GMEMä¸­ã€‚

SMä¸­çš„çº¿ç¨‹é™¤äº†è´Ÿè´£å‘èµ·è®¡ç®—å¤–ï¼Œè¿˜è¦å…ˆè´Ÿè´£æ¬è¿æ•°æ®ã€‚çº¿ç¨‹éœ€è¦æ‰¿æ‹…åœ°å€è®¡ç®—ã€è¶Šç•Œå¤„ç†ã€åŒæ­¥ç®¡ç†ç­‰ä¸€ç³»åˆ—ä»»åŠ¡ã€‚æ®è°ƒæŸ¥ï¼Œå¼€å‘è€…90%çš„æ—¶é—´èŠ±è´¹åœ¨ç¼–å†™æ•°æ®è®¿é—®çš„ä»£ç ä¸Šï¼Œ10%ä»¥ä¸Šçš„æ€§èƒ½æŸè€—æºäºå†…å­˜è®¿é—®å¼€é”€[^1]ã€‚

ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼Œè‹±ä¼Ÿè¾¾åœ¨Hopperæ¶æ„ä¸­å¼•å…¥äº† Tensor Memory Accelerator (TMA)[^2]ï¼Œå°†æ•°æ®è®¿é—®çš„å¤æ‚æ€§ä»è½¯ä»¶å±‚ï¼ˆçº¿ç¨‹ï¼‰å‰¥ç¦»ï¼Œäº¤ç”±ä¸“ç”¨ç¡¬ä»¶ï¼ˆTMAï¼‰å¤„ç†ï¼Œå®ç°æ•°æ®æ¬è¿ä¸è®¡ç®—è§£è€¦ã€‚

# TMAæ˜¯ä»€ä¹ˆ

TMAæ˜¯ä¸€ä¸ªåœ°å€è®¡ç®—å•å…ƒï¼Œç”¨äºåœ¨GMEMä¸SMEMä¹‹é—´ï¼Œæˆ–åœ¨ä¸€ä¸ªçº¿ç¨‹å—é›†ç¾¤ï¼ˆCTA Clusterï¼‰å†…çš„å¤šä¸ªCTAä¹‹é—´æ¬è¿å¼ é‡æ•°æ®ã€‚æœ¬æ–‡ä¸»è¦ä»¥GMEM->SMEMä¸ºä¾‹ï¼ŒSMEMåˆ°GMEMæ˜¯å¯¹ç§°çš„ã€‚

å¦‚ä¸“åˆ©[^3]ä¸­æ‰€ç¤ºï¼ŒTMAä½äºSMå±‚çº§ï¼Œæ¯ä¸ªSMä¸“æœ‰ä¸€ä¸ªTMAã€‚TMAæŠŠæ•°æ®ä»GMEMæ¬åˆ°SMå†…çš„SMEMï¼Œåç»­Functional Unitï¼Œä¹Ÿå°±æ˜¯CTA+Cuda coreï¼Œæ§åˆ¶æ•°æ®ä»SMEMåŠ è½½åˆ°å¯„å­˜å™¨ï¼ŒCuda coreè¿›è¡Œè®¡ç®—ã€‚

![](image/5b27d6abfcb67871230c55dc209a2e9e_7IuOjj8Lgm.png)

åœ¨A100ä¸­ï¼Œæ¬è¿æ•°æ®éœ€è¦ç”¨Threadæ¥äº§ç”Ÿè®¿å­˜è¯·æ±‚ï¼Œå¼•å…¥TMAåï¼Œæ•°æ®æ¬è¿ç”±TMAè‡ªåŠ¨å®Œæˆï¼Œthreadå¯ä»¥ç”¨ä½œå…¶å®ƒç”¨é€”ã€‚

![](image/c5e807886f6a8025c3f65fe167ea3f15_gvuN9JtOua.png)

æ•´ä½“æ¥è¯´ï¼ŒTMAå¹¶æ²¡æœ‰æ”¹å˜æ•°æ®é€šè·¯ï¼Œä¹Ÿæ²¡æœ‰æ”¹å˜æ¬è¿æ•°æ®çš„å¸¦å®½å¤§å°ï¼Œåªæ˜¯æ¬è¿æ•°æ®çš„æ§åˆ¶é€»è¾‘ä»threadåˆ‡æ¢åˆ°äº†TMAä¸Šã€‚

![](image/25255a3c41c9b68459716a1e524db81d_DIJn8fj0M7.png)

# å¼ é‡è®¿é—®

TMAä¸»è¦ç”¨äºæ¬è¿å¼ é‡ï¼Œä½†ä¹Ÿå¯ä»¥æ¬è¿æ²¡æœ‰è¢«å®šä¹‰ä¸ºå¼ é‡çš„è¿ç»­æ•°æ®ã€‚

## è®¿é—®æ–¹æ³•

TMAä½¿ç”¨å¼ é‡æè¿°ç¬¦ï¼ˆTensor Descriptorï¼Œæˆ–Tensor Mapï¼‰æ›¿ä»£æ˜¾å¼åœ°å€è®¡ç®—ï¼Œå¼€å‘è€…åªéœ€å®šä¹‰â€œæ¬ä»€ä¹ˆâ€ï¼Œè€Œæ— éœ€å…³å¿ƒâ€œæ€ä¹ˆæ¬â€ï¼Œé¿å…ä¸å¤æ‚çš„ç‰©ç†åœ°å€æ¥è§¦ã€‚æè¿°ç¬¦æ˜¯å‚¨å­˜åœ¨GMEMä¸­çš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼ŒåŒ…å«å¼ é‡çš„æ‰€æœ‰å±æ€§ã€‚å¦‚æœè¾“å…¥å¸ƒå±€å‘ç”Ÿæ›´æ”¹ï¼Œä¿®æ”¹GMEMä¸­çš„æè¿°ç¬¦å³å¯ï¼Œæ— éœ€é‡æ–°ä¿®æ”¹ç¼–è¯‘æ•´ä¸ªkernelã€‚

TMAä»¥Bounding Boxä¸ºå•ä½æ¬è¿æ•°æ®ï¼Œä¸€ä¸ªthreadå‘èµ·ä¸€æ¬¡TMAæ¬è¿æ“ä½œï¼Œæ¬è¿ä¸€ä¸ªBoxã€‚Boxæ˜¯å¼ é‡ä¸­æŠ å‡ºçš„ä¸€ä¸ªå—ï¼Œç»´åº¦ä¸å¼ é‡ç›¸åŒã€‚TMAæ”¯æŒ1\~5ç»´å¼ é‡ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè“è‰²ç«‹æ–¹ä½“æ˜¯åŸå§‹å¼ é‡ï¼Œç»¿è‰²ç«‹æ–¹ä½“æ˜¯ä¸€æ¬¡TMAæ“ä½œæ¬è¿çš„Boxã€‚å› ä¸ºè®¿é—®Boxåœ°å€å¿…é¡»16Byteå¯¹é½ï¼Œä½†å¼ é‡çš„è¾¹é•¿å¯èƒ½æ˜¯éå¯¹é½çš„ï¼Œæ‰€ä»¥è¦æ±‚å¼ é‡åŠ ä¸Špaddingï¼Œè®©æ¯ä¸ªæ–¹å‘ä¸Štensorç¬¬ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯16Bå¯¹é½çš„ï¼Œé€æ˜ç«‹æ–¹ä½“æè¿°çš„å°±æ˜¯å¼ é‡åš16Bå¯¹é½paddingåã€‚

![](image/214b3777b76321dcf1430eccbcc6de27_6WrrAqryhp.png)

å› æ­¤ï¼Œåœ¨æè¿°ç¬¦ä¸­æŒ‡å®šå¼ é‡çš„èµ·å§‹åœ°å€ã€æ•°æ®ç±»å‹ã€æ¬è¿æ¨¡å¼ï¼Œä»¥åŠè“è‰²ã€ç»¿è‰²ã€é€æ˜ç«‹æ–¹ä½“çš„å‚æ•°ï¼Œå°±å¯ä»¥æŒ‡å®šTMAå¦‚ä½•è®¿é—®å¼ é‡ã€‚å…·ä½“æœ‰ä»¥ä¸‹å‚æ•°ï¼š

- **tensorDataType**: å…ƒç´ çš„æ•°æ®ç±»å‹ã€‚
- **tensorRank**: å¼ é‡ç»´åº¦æ•°ï¼Œæ”¯æŒ1D\~5Dã€‚
- **globalAddress**: å¼ é‡çš„å†…å­˜èµ·å§‹åœ°å€ï¼Œéœ€16Bå¯¹é½ã€‚
- **globalDim**: ä¸€ä¸ªæ•°ç»„ï¼Œå­˜æ”¾å¼ é‡åœ¨æ¯ä¸ªç»´åº¦çš„é•¿åº¦ï¼ˆå›¾ä¸­çš„TensorSizeï¼‰ã€‚
- **globalStrides**: ä¸€ä¸ªæ•°ç»„ï¼Œå­˜æ”¾å¼ é‡åœ¨æ¯ä¸ªç»´åº¦paddingåçš„é•¿åº¦ï¼Œå³åœ¨æ¯ä¸ªç»´åº¦ä¸Šè¿ç»­ä¸¤è¡Œå¼ é‡é¦–åœ°å€ä¹‹é—´çš„é—´éš”ï¼ˆå›¾ä¸­çš„TensorStrideï¼‰ï¼Œéœ€è¦16Bå¯¹é½ã€‚
- **boxDim**: ä¸€ä¸ªæ•°ç»„ï¼Œå­˜æ”¾boxåœ¨æ¯ä¸ªç»´åº¦çš„é•¿åº¦ï¼ˆå›¾ä¸­çš„AccessBoxSizeï¼‰ï¼Œéœ€è¦16Bå¯¹é½ã€‚
- **elementSritde**: ä¸€ä¸ªæ•°ç»„ï¼Œå­˜æ”¾boxåœ¨æ¯ä¸ªç»´åº¦çš„é—´éš”ï¼Œå³åœ¨æ¯ä¸ªç»´åº¦ä¸Šè¿ç»­ä¸¤ä¸ªboxé¦–åœ°å€ä¹‹é—´çš„é—´éš”ï¼ˆå›¾ä¸­çš„TraversalStrideï¼‰ï¼Œboxä¹‹é—´æ˜¯å¯ä»¥é‡å çš„ã€‚éœ€è¦16Bå¯¹é½ã€‚
- **interleaveã€swizzle**: ç”¨äºæ”¹å˜æ•°æ®æ’åˆ—çš„é¡ºåºï¼Œä¸‹æ–‡ä»‹ç»ã€‚
- **L2Promotion**: ç”¨äºL2 cacheå–æ•°æ®ä¼˜åŒ–ã€‚
- **oobFill**: å½“è®¿é—®çš„boxè¶…è¿‡å¼ é‡çš„èŒƒå›´æ—¶ï¼Œä¼šå¡«å……ä¸º0æˆ–NaNã€‚å¦‚ä¸‹å›¾é»„è‰²åŒºåŸŸã€‚

![](image/8c773f5355a143eab46ab1333196f712_r1YzVVpyge.png)

å‚æ•°è¯¦è§[CUDA Driver: Tensor Map Object Management](https://docs.nvidia.com/cuda/cuda-driver-api/group__CUDA__TENSOR__MEMORY.html "CUDA Driver: Tensor Map Object Management")

ä¸€æ¡TMAæŒ‡ä»¤æ¬è¿ä¸€ä¸ªboxï¼Œä¸ºTMAæä¾›æè¿°ç¬¦ï¼Œä»¥åŠè¦è®¿é—®çš„boxåœ¨å¼ é‡å†…çš„åæ ‡ï¼Œç»™å‡ºç›®æ ‡åœ°å€ï¼ŒTMAå°±ä¼šå¼€å§‹æ¬è¿è¿™ä¸ªboxã€‚ &#x20;
åæ ‡çš„ç¡®å®šæ–¹æ³•ï¼Œä»¥äºŒç»´ä¸¾ä¾‹ï¼š

$$
boxé¦–åœ°å€=å¼ é‡é¦–åœ°å€+coord[x]*TraversalStride[x]+coord[y]*TraversalStride[y]
$$

GMEM->SMEMæ—¶ï¼Œåæ ‡å¯ä»¥ä¸ºè´Ÿæ•°ï¼Œä½†SMEM->GMEMæ—¶ï¼Œåæ ‡å¿…é¡»ä¸ºæ­£ã€‚

## æ¬è¿æ¨¡å¼

å¼ é‡æ¬è¿çš„è¯¦ç»†æ¨¡å¼è¯¦è§[CUDA: Tensor Access Modes](https://docs.nvidia.com/cuda/parallel-thread-execution/index.html#tensor-access-modes "CUDA: Tensor Access Modes")

TMAæ”¯æŒä¸¤ç§å¼ é‡æ¬è¿æ¨¡å¼ï¼ŒTile modeå’Œim2col modeã€‚

### Tile Mode

åœ¨Tile Modeä¸‹ï¼Œboxæ¬è¿è¿›SMEMåä¿æŒä¸GMEMä¸­ç›¸åŒçš„æ’å¸ƒã€‚ &#x20;

å¯¹äº2DçŸ©é˜µï¼ŒTMAè¿˜æ”¯æŒä¸¤ç§ç‰¹æ®Šçš„æ¨¡å¼ï¼š

- **tile.scatter4 mode**ï¼Œå°†å¼ é‡ä¸­è¿ç»­çš„å››è¡Œï¼Œæ¬è¿åå˜ä¸ºåˆ†æ•£çš„å››è¡Œã€‚
- **tile.gather4 mode**ï¼Œå¼ é‡ä¸­åˆ†æ•£çš„å››è¡Œï¼Œæ¬è¿åå˜ä¸ºè¿ç»­çš„å››è¡Œã€‚ &#x20;

ä¸‹å›¾ä¸¾ä¾‹ä¸ºgather4 modeï¼Œæä¾›èµ·å§‹åæ ‡(1, 2), (1, 5), (1, 0) ,(1, 9)ï¼Œä»¥åŠæ¬è¿é•¿åº¦4ï¼ŒTMAå°†æŒ‰åæ ‡é¡ºåºï¼ŒæŠŠè¿™å››è¡Œæ¬è¿è¿›SMEMä¸­ï¼Œå¹¶æ‹¼åˆ°è¿ç»­å››è¡Œã€‚

![](image/601a99d320d6ea39c12fb3ba339ffb42_adxYzywdGD.png)

### im2col Mode

å¼ é‡å°†è¢«è§†ä¸ºä¸€ç»„å›¾åƒåšim2colçš„è½¬æ¢åæ”¾å…¥SMEMï¼Œç”¨äºå·ç§¯è¿ç®—ã€‚æ­¤æ—¶ä¸ç”¨boxSizeå‚æ•°ï¼Œæ”¹ä¸ºBounding-Box Lower-Cornerï¼ŒBounding-Box Upper-Cornerï¼ŒPixels-per-Columnï¼ŒChannels-per-Pixelå‚æ•°ç¡®å®šim2colçš„è®¿é—®é¡ºåºã€‚æ”¯æŒ3Dã€4Dã€5D[^4]ã€‚

## Interleave layout

Interleave layoutæ”¯æŒ3Dã€4Dã€5Dï¼Œæœ‰ä¸‰ç§æ¨¡å¼ï¼š

- **No interleave (NDHWC)**
- **8 byte interleave (NC/8DHWC8)**Â : C8 utilizes 16 bytes in memory assuming 2B per channel.
- **16 byte interleave (NC/16HWC16)**Â : C16 utilizes 32 bytes in memory assuming 4B per channel.

ä»¥8 byte interleaveä¸¾ä¾‹ï¼šNDHWCæ ¼å¼çš„å¼ é‡ï¼Œæœ¬æ¥æ˜¯ä»¥Nï¼ŒDï¼ŒHï¼ŒWã€Cä»å¤–åˆ°å†…çš„é¡ºåºéå†å­˜å‚¨ã€‚æ­¤æ¨¡å¼ä¸‹ï¼Œåœ¨æœ€å†…å±‚Channelç»´åº¦è¢«åˆ‡ç‰‡æˆC/8ä¸ªé•¿åº¦ä¸º8çš„ç»„ï¼Œè¿ç»­çš„8ä¸ªchannel(C8)è¢«å­˜å‚¨åœ¨ä¸€èµ·ã€‚å¤–å±‚æŒ‰Nï¼ŒC/8ï¼ŒDï¼ŒHï¼ŒWçš„é¡ºåºå¾ªç¯éå†ã€‚å½“Cä¸èƒ½è¢«8æ•´é™¤æ—¶ï¼Œæœ€åä¸€ç»„Cä¼šè¢«0å¡«å……ã€‚ &#x20;
è¿™ç§Interleave layoutåº”è¯¥æ˜¯ä¸“ä¸ºTensor coreè®¾è®¡ï¼Œæ¯ä¸ªåˆ‡ç‰‡æ­£å¥½åŒ¹é…ä¸€ä¸ªTensot Coreçš„å¤§å°ï¼Œåšä¸€æ¬¡çŸ©é˜µä¹˜æ³•ã€‚ &#x20;
TMAä¸åšlayoutçš„è½¬æ¢ï¼Œåªæ˜¯ä»¥è¿™ç§é¡ºåºè®¿é—®GMEMï¼Œè¦æ±‚GMEMä¸­å­˜æ”¾çš„åˆ‡ç‰‡åçš„æ ¼å¼ã€‚

## swizzling mode

SMEMç”±32ä¸ªbankç»„æˆï¼Œåœ¨ä¸€æ¬¡è®¿é—®ä¸­ï¼Œå¯ä»¥åŒæ—¶è¯»/å†™å¤šä¸ªbankï¼Œä½†ä¸€ä¸ªbankåªå…è®¸è¯»ä¸€ä¸ªå’Œå†™ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœåŒæ—¶è¯»/å†™çš„ä¸¤ä¸ªå…ƒç´ åœ¨åŒä¸€ä¸ªbankä¸­ï¼Œåˆ™ç§°ä¸ºbank conflictï¼Œåªèƒ½ç­‰ä¸€ä¸ªè®¿é—®ç»“æŸåæ‰å…è®¸å¦ä¸€ä¸ªè®¿é—®ã€‚å¦‚ä¸‹å›¾ï¼Œä¸€åˆ—ä¸ºä¸€ä¸ªbankï¼Œä¸€å…±32ä¸ªbankã€‚ &#x20;

ä¾‹å¦‚ï¼Œå¦‚æœåšçŸ©é˜µä¹˜æ³•ï¼Œæ˜¯ç”¨çŸ©é˜µAçš„è¡Œä¹˜ä»¥çŸ©é˜µBçš„åˆ—ï¼Œå‡è®¾æœ‰Bæ˜¯ä¸€ä¸ª16\*32çš„çŸ©é˜µï¼Œä»¥è¡Œä¼˜å…ˆæ¬å…¥SMEMä¸­ã€‚æ¬å…¥æ—¶ï¼ˆå¦‚ä¸‹å›¾ç»¿è‰²æ¡†ï¼‰ï¼Œæ˜¯åˆ†åˆ«å†™å…¥32ä¸ªbankï¼Œæ²¡æœ‰å‘ç”Ÿbank conflictï¼Œå¯ä»¥åŒæ—¶å†™å…¥ã€‚ä½†åšä¹˜æ³•ä»¥åˆ—è¯»å‡ºæ—¶ï¼ˆé«˜äº®è‰²0å’Œ1ï¼‰ï¼Œä¸€åˆ—æ•°æ®åœ¨åŒä¸€ä¸ªbankä¸­ï¼Œæ— æ³•åŒæ—¶è¯»å‡ºï¼Œåªèƒ½æŒ‰é¡ºåºä¸€ä¸ªä¸€ä¸ªè¯»å‡ºèŠ±è´¹å¾ˆå¤šæ—¶é—´ã€‚

![](image/1415b4f790c7c2d0a877d1e4932dc44a_RqyJiE6t8r.png)

Swizzlingæ“ä½œå°±æ˜¯ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå¦‚ä¸‹å›¾ï¼Œæ¬è¿è¿›SMEMæ—¶ï¼ˆæ¨ªå‘ç»¿è‰²æ¡†ï¼‰ï¼Œä»¥äº¤é”™çš„é¡ºåºå†™å…¥32ä¸ªbankä¸­ï¼Œæ²¡æœ‰bank conflictã€‚è¯»å‡ºæ—¶ï¼Œå› ä¸ºåšäº†äº¤é”™ï¼ŒåŸæœ¬ä¸€åˆ—ä¸­çš„æ•°æ®è¢«åˆ†æ•£åˆ°äº†ä¸åŒçš„bankï¼ˆé«˜äº®è‰²0å’Œ1ï¼‰ï¼Œå› æ­¤å¯ä»¥ä¸€æ¬¡è¯»å‡ºBçŸ©é˜µçš„ä¸€åˆ—ï¼ŒèŠ‚çº¦äº†è®¿å­˜æ—¶é—´ã€‚

![](image/d536a64a61eb8493a29865311b3b05ce_dLkBoDqYAL.png)

TMAæ”¯æŒä»¥ä¸‹å‡ ç§Swizzling Modeï¼Œç®€å•æ¥è¯´å°±æ˜¯ä¸åŒçš„äº¤é”™æ–¹æ³•[^5]ã€‚

![](image/eab64d4635180d078c78d0e64d1c344d_nmZVS72yR7.png)

## æ”¯æŒmulticast

åœ¨æ•°æ®å¹¶è¡Œè®­ç»ƒä¸­ï¼Œæ‰€æœ‰SMå¯èƒ½éœ€è¦è®¿é—®ç›¸åŒçš„æƒé‡è¿›è¡Œè®¡ç®—ã€‚multicastæ”¯æŒä¸€ä¸ªSMå‘èµ·çš„TMAè®¿é—®ï¼Œæ•°æ®å¹¿æ’­åˆ°å¤šä¸ªSMçš„SMEMä¸Šã€‚ç¼–ç¨‹æ—¶é€šè¿‡CTA ID maskå®šä½éœ€è¦æ•°æ®çš„SMã€‚

## æ”¯æŒè§„çº¦

TMAæ”¯æŒè§„çº¦æ“ä½œï¼ˆReductionï¼‰ï¼šAND, ADD, XOR, MIN, MAX, DEC, OR, INCç­‰ã€‚å°±æ˜¯æŠŠæ¬è¿çš„æ•°æ®ï¼Œå’Œç›®çš„åœ°çš„æ•°æ®åšè¿ç®—ï¼Œç»“æœå­˜æ”¾è¿›ç›®çš„åœ°ã€‚

# TMAçš„åŒæ­¥æœºåˆ¶

å› ä¸ºTMAæ˜¯å¼‚æ­¥äºSMçš„ï¼Œå› æ­¤å½“æ•°æ®å‡†å¤‡å®Œæˆåï¼Œéœ€è¦é€šçŸ¥SMã€‚è‹±ä¼Ÿè¾¾æŠŠæ•°æ®åŒæ­¥æŠ½è±¡ä¸ºç”Ÿäº§è€…ï¼ˆproducerï¼‰å’Œæ¶ˆè´¹è€…ï¼ˆconsumerï¼‰ã€‚

![](image/733fc47cfd4398cb241c3f89fde60a1e_e0Q_WAnCi4.png)

å½“ç”Ÿäº§è€…å®Œæˆæ•°æ®å‡†å¤‡åï¼Œä¼šå‘å‡ºarrive()çš„æ ‡è¯†ã€‚æ¶ˆè´¹è€…ä¼šæå‰å‘å‡ºwait()ï¼Œç­‰å¾…æ¶ˆè´¹è€…çš„arrive()ã€‚æ¶ˆè´¹è€…åœ¨ç­‰å¾…ç”Ÿäº§è€…çš„arriveæ—¶ï¼Œå¯ä»¥å…ˆè¿è¡Œä¸ä¾èµ–è¿™äº›æ•°æ®çš„å…¶å®ƒä»»åŠ¡ï¼Œè¿™å°±å¸¦æ¥äº†æ›´é«˜çš„å¹¶å‘æ€§ã€‚å¦‚ä¸Šå›¾ä¸­ï¼ŒProcessä¾èµ–Copy into SMEMçš„æ•°æ®ï¼ŒCopy to Globalä¾èµ–Processçš„æ•°æ®ï¼Œå¯¹åŒä¸€å—æ•°æ®ï¼Œåä¸€ä¸ªæ“ä½œå¿…é¡»ç­‰å¾…å‰é¢çš„æ“ä½œå®Œæˆã€‚ä½†å¯¹äºä¸åŒçš„æ•°æ®ï¼Œå¦‚æ¬è¿è“è‰²æ•°æ®å’Œè®¡ç®—ç»¿è‰²æ•°æ®å°±å¯ä»¥åŒæ—¶è¿è¡Œï¼ŒèŠ‚çº¦ç­‰å¾…æ—¶é—´ã€‚ &#x20;

ä»¥ä¸ŠåŒæ­¥æœºåˆ¶åœ¨A100ä¸­ä¹Ÿæœ‰ç”¨åˆ°ï¼Œä¸è¿‡A100ä¸­æ˜¯threadå‘èµ·çš„å¼‚æ­¥æ¬è¿ï¼Œè€ŒH100ä¸­å˜ä¸ºTMAã€‚ &#x20;

åœ¨H100ä¸­ï¼Œè¿˜æä¾›äº†æ–°æœºåˆ¶ï¼štransaction barrierã€‚åœ¨å¤šæ¬¡æ¬è¿çš„åœºæ™¯ä¸‹ï¼ŒTMAæ¯æ¬è¿ä¸€ä¸ªboxï¼Œ transaction counterä¼š+1ï¼Œå½“counterè¾¾åˆ°é¢„è®¾çš„å€¼åï¼Œæ¶ˆè´¹è€…è‡ªåŠ¨é‡Šæ”¾waitï¼Œæ— éœ€ä¸ºæ¯æ¬¡TMAæ¬è¿åšåŒæ­¥ã€‚counterçš„æ¥æºå¯ä»¥æ˜¯å¤šä¸ªä¸åŒçš„copyæ“ä½œã€‚

# TMAæ¶æ„

## æ‹“æ‰‘ä½ç½®

åœ¨GPUä¸­TMAçš„ä½ç½®å¦‚ä¸‹å›¾ã€‚ &#x20;

åœ¨ä¸€ä¸ªGPCä¸­æœ‰å¤šä¸ªSMï¼Œä¸€ä¸ªSMå¯¹åº”ä¸€ä¸ªTMAï¼ŒTMAæ¥åˆ°åˆ°MMUä¸Šï¼ŒMMUåšè™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢ã€å†…å­˜ä¿æŠ¤ã€è®¿é—®ä»²è£ç­‰ã€‚ &#x20;

å¤šä¸ªGPCä¸­MMUæ¥åˆ°XBaræ€»çº¿ä¸Šï¼Œè®¿é—®Memory Partition Unitï¼Œè¿™ä¸ªå•å…ƒç”¨æ¥è®¿é—®ä¸åŒçš„ç‰‡å¤–HBMã€‚

![å›¾ä¸­çš„DPC 1120(Data Processing Clusters)ï¼ŒæŠŠå‡ ä¸ªSMç»„æˆä¸€ç»„å…±åŒç®¡ç†ã€‚æŒ‡çš„æ˜¯äº§å“ä¸­çš„TPCï¼ŒH100å’ŒB200ä¸­ï¼Œä¸€ä¸ªTPCç®¡ç†ä¸¤ä¸ªSMã€‚åœ¨GPCä¸­ï¼ŒPipeline ManageræŠŠä»»åŠ¡åˆ†ç»™ä¸åŒçš„DPCï¼Œåœ¨DPCå†…éƒ¨ï¼ŒMPCè´Ÿè´£æŠŠä»»åŠ¡åˆ‡åˆ†ç»™SMæˆ–Primitive Engineï¼ˆå‡ ä½•è®¡ç®—ï¼‰ã€‚ å›¾ä¸­çš„DPC 1120(Data Processing Clusters)ï¼ŒæŠŠå‡ ä¸ªSMç»„æˆä¸€ç»„å…±åŒç®¡ç†ã€‚æŒ‡çš„æ˜¯äº§å“ä¸­çš„TPCï¼ŒH100å’ŒB200ä¸­ï¼Œä¸€ä¸ªTPCç®¡ç†ä¸¤ä¸ªSMã€‚åœ¨GPCä¸­ï¼ŒPipeline ManageræŠŠä»»åŠ¡åˆ†ç»™ä¸åŒçš„DPCï¼Œåœ¨DPCå†…éƒ¨ï¼ŒMPCè´Ÿè´£æŠŠä»»åŠ¡åˆ‡åˆ†ç»™SMæˆ–Primitive Engineï¼ˆå‡ ä½•è®¡ç®—ï¼‰ã€‚ ](image/ab528487d40c9e6edfff1f865184975f_l7mZSy5bDn.png "å›¾ä¸­çš„DPC 1120(Data Processing Clusters)ï¼ŒæŠŠå‡ ä¸ªSMç»„æˆä¸€ç»„å…±åŒç®¡ç†ã€‚æŒ‡çš„æ˜¯äº§å“ä¸­çš„TPCï¼ŒH100å’ŒB200ä¸­ï¼Œä¸€ä¸ªTPCç®¡ç†ä¸¤ä¸ªSMã€‚åœ¨GPCä¸­ï¼ŒPipeline ManageræŠŠä»»åŠ¡åˆ†ç»™ä¸åŒçš„DPCï¼Œåœ¨DPCå†…éƒ¨ï¼ŒMPCè´Ÿè´£æŠŠä»»åŠ¡åˆ‡åˆ†ç»™SMæˆ–Primitive Engineï¼ˆå‡ ä½•è®¡ç®—ï¼‰ã€‚ å›¾ä¸­çš„DPC 1120(Data Processing Clusters)ï¼ŒæŠŠå‡ ä¸ªSMç»„æˆä¸€ç»„å…±åŒç®¡ç†ã€‚æŒ‡çš„æ˜¯äº§å“ä¸­çš„TPCï¼ŒH100å’ŒB200ä¸­ï¼Œä¸€ä¸ªTPCç®¡ç†ä¸¤ä¸ªSMã€‚åœ¨GPCä¸­ï¼ŒPipeline ManageræŠŠä»»åŠ¡åˆ†ç»™ä¸åŒçš„DPCï¼Œåœ¨DPCå†…éƒ¨ï¼ŒMPCè´Ÿè´£æŠŠä»»åŠ¡åˆ‡åˆ†ç»™SMæˆ–Primitive Engineï¼ˆå‡ ä½•è®¡ç®—ï¼‰ã€‚ ")

![](image/254e145293afb5221805bc91edb842cb_go9OSNMbOh.png)

## å·¥ä½œæµç¨‹

TMAä¸€ä¸ªå…¸å‹çš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š

- SMå‘é€å•æ¬¡è¯·æ±‚ï¼ˆ204ï¼‰ï¼Œæä¾›2.1èŠ‚çš„ä¿¡æ¯å’ŒæŒ‡ä»¤å¯åŠ¨TMAï¼Œæ­¤åTMAå¼€å§‹å¼‚æ­¥æ‰§è¡Œã€‚
- åœ°å€è®¡ç®—ç”±TMAå®Œæˆï¼Œå¦‚æœæ•°æ®é‡è¿‡å¤§ï¼ŒTMAåˆ†è§£ä¸ºå¤šä¸ªå­è¯·æ±‚ï¼Œç¬¦åˆL2å•æ¬¡è®¿é—®çš„å¤§å°ï¼Œé€ä¸ªå‘é€åˆ°L2ï¼ˆ206ï¼‰ã€‚
- æ•°æ®è¿”å›TMAï¼ˆ208ï¼‰ï¼ŒTMAæŠŠæ•°æ®å†™å…¥SMEM (212)ã€‚
- æ¯ä¸ªå­å—å†™å…¥SMEMåï¼Œè®¡æ•°å™¨é€’å¢ï¼ŒSMç›‘æ§è®¡æ•°å™¨ï¼ˆ214ï¼‰ï¼Œåˆ°è¾¾é¢„æœŸå€¼åSMå°±çŸ¥é“æ•°æ®å·²å°±ç»ªã€‚ &#x20;

  ç›¸æ¯”ä¹‹å‰çš„LDGSTSæ–¹æ³•ï¼ŒSMä¸Šçš„æ¯ä¸ªçº¿ç¨‹ä¸éœ€è¦è‡ªå·±è®¡ç®—æ¯ä¸ªå­å—çš„åœ°å€ï¼Œåªéœ€ä¸€ä¸ªçº¿ç¨‹å‘å‡ºå•æ¬¡çš„è¯·æ±‚ï¼Œç”±TMAè´Ÿè´£åç»­æ“ä½œã€‚åœ°å€è®¡ç®—ç”±TMAå®Œæˆï¼ŒSMä¸å†éœ€è¦ä¸»åŠ¨ç®¡ç†æ¯ä¸ªå­å—çš„åŒæ­¥ï¼Œä»…éœ€ç›‘æ§è®¡æ•°å™¨æœ€ç»ˆçŠ¶æ€ã€‚åœ¨å‘å‡ºè¯·æ±‚åSMå¯å¼‚æ­¥çš„æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚

![](image/271af8452143e1425f3787195c8fe88e_DC9R06Vfzd.jpg)

## TMAå†…éƒ¨æµæ°´çº¿

- MIOC(Memory I/O Controller, 604)æ¥æ”¶SMçš„è¯·æ±‚ã€‚
- è¯·æ±‚æ”¾å…¥Request Queueï¼ˆ606ï¼‰ä¸­ï¼Œå¯ä»¥æ ¹æ®è¯·æ±‚ç±»å‹è°ƒæ•´ä¼˜å…ˆçº§ã€‚
- å¯¹äºå¼ é‡è¯·æ±‚ï¼Œéœ€è¦ä¸€ä¸ªæŒ‡å‘GMEMä¸­æè¿°ç¬¦çš„åœ°å€ï¼Œä»GMEMè¯»å–æè¿°ç¬¦ã€‚
- ä¸ºäº†é¿å…å¤šæ¬¡è®¿é—®GMEMä¸­ç›¸åŒçš„æè¿°ç¬¦ï¼ŒTMAä¸­æ”¾ç½®äº†Descriptor Cacheæš‚å­˜æè¿°ç¬¦ã€‚
- Setup Block(610)åˆå¹¶Tensor å’Œ è¯·æ±‚æŒ‡ä»¤çš„ä¿¡æ¯ï¼Œè¿›è¡Œé”™è¯¯æ£€æŸ¥ã€‚
- Request Generatoréå†boxä¸­æ¯ä¸ªå…ƒç´ ï¼Œè®¡ç®—å…¶åœ¨GMEMä¸­çš„ç‰©ç†åœ°å€ï¼Œå’Œåœ¨SMEMä¸­çš„åœ°å€ï¼Œå‘å‡ºL2 requestã€‚swizzleåœ°å€è®¡ç®—ä¹Ÿåœ¨æ­¤ç”Ÿæˆã€‚
- requesté€šè¿‡GNICï¼ˆgeneral network interface controllerï¼Œ614ï¼‰å‘é€åˆ°L2ã€‚
- Req Completion Tracking block(618)è´Ÿè´£è·Ÿè¸ªæ•°æ®è¯·æ±‚æ˜¯å¦å®Œæˆã€‚
- éå¼ é‡çš„è¿ç»­æ•°æ®è®¿é—®å¯è·³è¿‡Descriptor Cacheå’ŒSetupéƒ¨åˆ†ã€‚

![](image/3ed45153cdb60e06589e52af7b0e8584_gOqaap3WxH.png)

# TMAç¼–ç¨‹æ–¹å¼

## CUTLASS C++

> ğŸ“Œcutlass TMA ç¼–ç¨‹å¯å‚è€ƒï¼š[tutorial-hopper-tma](https://research.colfax-intl.com/tutorial-hopper-tma/ "tutorial-hopper-tma")

æ„å»ºäºCuTeåº“ä¹‹ä¸Šçš„CUTLASS 3.0ï¼Œä¸ºTMAç¼–ç¨‹æä¾›äº†ä¸€å¥—C++æ¨¡æ¿æŠ½è±¡API ã€‚TMAç¼–ç¨‹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ç¯èŠ‚ï¼š

- ä¸»æœºç«¯é…ç½®ï¼šä½¿ç”¨make\_tma\_copyå‡½æ•°ï¼Œåˆ›å»ºä¸€ä¸ªåŒ…å«äº†2.1èŠ‚ä»‹ç»çš„Tmaæè¿°ç¬¦ã€‚
- ä¼ é€’è‡³GPUï¼šæè¿°ç¬¦ä¼šè¢«åŠ è½½åˆ°GMEM/constantå†…å­˜ä¸­ ã€‚
- è®¾å¤‡ç«¯æ‰§è¡Œï¼šå•çº¿ç¨‹ï¼ˆä¾‹å¦‚threadIdx.x == 0ï¼‰å‘èµ·TMAçš„async copyå‘½ä»¤ã€‚

cutlassä¸ºTMAæä¾›å¦‚ä¸‹æ¥å£ï¼š

- **TMA\_LOADç³»åˆ—**ï¼Œä»GMEMåŠ è½½æ•°æ®åˆ°SMEMï¼š
  ```c++ 
  struct SM90_TMA_LOAD_1D / 2D / 3D / 4D / 5D {
    struct void copy(void const* desc_ptr, uint64_t* mbar_ptr, void* smem_ptr,
                     int32_t const& crd...);
  };

  ```

- TMA\_LOAD\_IM2COLç³»åˆ—ï¼Œå·ç§¯ä¸“ç”¨çš„im2colæ¨¡å¼
  ```c++ 
  struct SM90_TMA_LOAD_IM2COL_3D / 4D / 5D {
    static void copy(void const* desc_ptr, uint64_t* mbar_ptr, void* smem_ptr,
                     int32_t const& coord_c, int32_t const& coord_w,
                     int32_t const& coord_n, uint16_t const& offset_w);
  };

  ```

- TMA\_LOAD\_MULTICASTç³»åˆ—ï¼Œé›†ç¾¤å†…å¤šSMåŒæ—¶æ¥æ”¶åŒä¸€æ•°æ®ï¼š
  ```c++ 
  struct SM90_TMA_LOAD_MULTICAST_1D / 2D / 3D / 4D / 5D {
    static void copy(void const* desc_ptr, uint64_t* mbar_ptr,
                     uint16_t multicast_mask, void* smem_ptr,
                     int32_t const& crd...);
  };

  ```

- TMA\_STOREç³»åˆ—ï¼Œä»SMEM storeåˆ°GMEMï¼š
  ```c++ 
  struct SM90_TMA_STORE_1D / 2D / 3D / 4D / 5D {
    static void copy(void const* desc_ptr, void const* smem_ptr,
                     int32_t const& crd...);
  };
  ```

- **TMA\_REDUCE\_ADDç³»åˆ—**ï¼Œä¸ç›®æ ‡åœ°å€åšè§„çº¦addåå­˜å…¥ï¼š
  ```c++ 
  struct SM90_TMA_REDUCE_ADD_1D / 2D / 3D / 4D / 5D {
    static void copy(void const* desc_ptr, void const* smem_ptr,
                     int32_t const& crd...);
  };

  ```


CUTLASSä½¿ç”¨å‡½æ•°é‡è½½æä¾›ç»Ÿä¸€çš„æ¥å£, æ ¹æ®tensorçš„ç»´åº¦ç¡®å®šè°ƒç”¨å“ªæ¡æŒ‡ä»¤æ‰§è¡ŒTMAï¼Œç®€åŒ–ç”¨æˆ·ç¼–ç¨‹ã€‚

æ¯ç§LOADæ“ä½œéƒ½æä¾›å¯¹åº”çš„PREFETCHç‰ˆæœ¬ï¼Œæ›´å¤šè¯¦ç»†ä»£ç è§ï¼š[copy\_sm90\_tma.hpp](https://github.com/NVIDIA/cutlass/blob/main/include/cute/arch/copy_sm90_tma.hpp "copy_sm90_tma.hpp")

## PTX

PTXæ˜¯è‹±ä¼Ÿè¾¾å¼€æ”¾ç»™ç”¨æˆ·çš„è™šæ‹Ÿæ±‡ç¼–è¯­è¨€ï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯Cudaä»£ç è½¬æ¢ä¸ºçœŸæ­£çš„GPUç¡¬ä»¶æŒ‡ä»¤çš„ä¸­é—´å±‚ã€‚CUTLASSä¸­å¯¹TMAçš„æ“ä½œå…¶å®å°±æ˜¯è°ƒç”¨ç›¸åº”çš„PTXæŒ‡ä»¤ã€‚

ä¸TMAç›¸å…³çš„PTXæŒ‡ä»¤æœ‰ä»¥ä¸‹å‡ ç±»ï¼š

1. **Bulk Copy / Reduce / Prefetch**ï¼ˆéå¼ é‡çš„æ¬è¿ï¼‰ &#x20;

   `cp.async.bulk` &#x20;

   `cp.reduce.async.bulk` &#x20;

   `cp.async.bulk.prefetch`
2. **Tensor Copy / Reduce / Prefetch**ï¼ˆå¤šç»´å¼ é‡æ¬è¿ï¼‰ &#x20;

   `cp.async.bulk.tensor` &#x20;

   `cp.reduce.async.bulk.tensor` &#x20;

   `cp.async.bulk.prefetch.tensor`
3. **åŒæ­¥ç®¡ç†æŒ‡ä»¤** &#x20;

   `cp.async.bulk.commit_group` &#x20;

   `cp.async.bulk.wait_group`
4. **ä¿®æ”¹å·²å­˜åœ¨çš„Tensor map (æè¿°ç¬¦)å­—æ®µ** &#x20;

   `tensormap.replace`

å…³äºPTXæŒ‡ä»¤çš„å…·ä½“ä»‹ç»è§ï¼š[CUDA: asynchronous-copy](https://docs.nvidia.com/cuda/parallel-thread-execution/index.html#data-movement-and-conversion-instructions-asynchronous-copy "CUDA: asynchronous-copy")

# åº”ç”¨

**DeepSeek**å¼€æºçš„**DeepGEMM**æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„çŸ©é˜µä¹˜æ³•åº“ï¼Œåˆ©ç”¨TMAåŠ è½½ LHSçŸ©é˜µã€ç¼©æ”¾å› å­ã€RHSçŸ©é˜µç­‰ã€‚ä¹Ÿä½¿ç”¨äº†å¤šæ’­åœ¨å¤šCTAé—´å…±äº«æƒé‡ï¼Œå‡å°‘å†—ä½™åŠ è½½[^6]ã€‚

**Flash Attention 3**æ˜¯ä¸€ç§åŸºäºHopper GPUé«˜åº¦ä¼˜åŒ–çš„Transformeræ¶æ„ï¼Œå…¶ä¸­ä¹Ÿåˆ©ç”¨TMAå¼‚æ­¥çš„æŠŠQKVçŸ©é˜µåŠ è½½åˆ°SMEMï¼Œå¹¶åˆ©ç”¨swizzleé«˜æ•ˆçš„å®Œæˆæ•°æ®è½¬ç½®ç”¨äºtensor core[^7]ã€‚

**GTC 2024ä¸Šçš„Topic**ï¼š[Advanced Performance Optimization in CUDA](https://www.nvidia.com/en-us/on-demand/session/gtc24-s62192/ "Advanced Performance Optimization in CUDA")

[^1]: NVIDIA: Techniques for efficiently transferring data to a processor [https://patentimages.storage.googleapis.com/2e/65/c9/73308c2c12e3d5/US11080051.pdf](https://patentimages.storage.googleapis.com/2e/65/c9/73308c2c12e3d5/US11080051.pdf "https://patentimages.storage.googleapis.com/2e/65/c9/73308c2c12e3d5/US11080051.pdf")

[^2]: Hopper Architecture Whitepaper
    [https://resources.nvidia.com/en-us-hopper-architecture/](https://resources.nvidia.com/en-us-hopper-architecture/ "https://resources.nvidia.com/en-us-hopper-architecture/")

[^3]: NVIDIA: Method and Apparatus for Efficient Access to Multidimensional Data Structures and/or Other Large Data Blocks [https://patentimages.storage.googleapis.com/23/89/13/0914c8f599bd9e/US20230289304A1.pdf](https://patentimages.storage.googleapis.com/23/89/13/0914c8f599bd9e/US20230289304A1.pdf "https://patentimages.storage.googleapis.com/23/89/13/0914c8f599bd9e/US20230289304A1.pdf")

[^4]: im2col mode detail
    [https://docs.nvidia.com/cuda/parallel-thread-execution/index.html#tensor-im2col-mode](https://docs.nvidia.com/cuda/parallel-thread-execution/index.html#tensor-im2col-mode "https://docs.nvidia.com/cuda/parallel-thread-execution/index.html#tensor-im2col-mode")

[^5]: Swizzling Modes Detail
    [https://docs.nvidia.com/cuda/parallel-thread-execution/index.html#tensor-swizzling-modes](https://docs.nvidia.com/cuda/parallel-thread-execution/index.html#tensor-swizzling-modes "https://docs.nvidia.com/cuda/parallel-thread-execution/index.html#tensor-swizzling-modes")

[^6]: deepseek: DeepGEMM
    [https://github.com/deepseek-ai/DeepGEMM](https://github.com/deepseek-ai/DeepGEMM "https://github.com/deepseek-ai/DeepGEMM")

[^7]: Flash Attention 3 Paper
    [https://arxiv.org/html/2407.08608v1](https://arxiv.org/html/2407.08608v1 "https://arxiv.org/html/2407.08608v1")
